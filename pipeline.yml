jobs:
- name: test-and-publish-framework
  plan:
  - aggregate:
    - get: pipeline
    - get: project
      resource: framework-git
      trigger: true
    - get: framework-snapshot
  - task: build-artifacts
    file: pipeline/tasks/build-artifacts.yml
  - task: update-snapshot
    file: pipeline/tasks/update-snapshot.yml
  - put: framework-artifact
    params:
      file: build-artifacts-output/framework-*.jar
      pom_file: build-artifacts-output/framework-*.pom
      version_file: build-artifacts-output/version
  - put: framework-snapshot
    params: {repository: update-snapshot-output}

resource_types:
- name: maven-resource
  type: docker-image
  source:
    repository: patrickcrocker/maven-resource
    tag: latest

resources:
- name: pipeline
  type: git
  source:
    uri: {{ci-git-uri}}
    branch: master
    private_key: {{git-private-key}}

- name: framework-git
  type: git
  source:
    uri: {{framework-git-uri}}
    branch: master
    private_key: {{git-private-key}}

# - name: framework-version
#   type: semver
#   source:
#     driver: git
#     initial_version: 1.0.0
#     uri: {{framework-version-uri}}
#     branch: {{framework-version-branch}}
#     file: version
#     private_key: {{git-private-key}}

- name: framework-snapshot
  type: git
  source:
    uri: {{framework-snapshot-uri}}
    branch: {{framework-snapshot-branch}}
    private_key: {{git-private-key}}

# - name: client-git
#   type: git
#   source:
#     uri: {{client-git-uri}}
#     branch: master
#     private_key: {{git-private-key}}

- name: framework-artifact
  type: maven-resource
  source:
    url: {{nexus-uri}}
    artifact: com.example:framework:pom
    username: {{nexus-username}}
    password: {{nexus-password}}
    skip_cert_check: true
